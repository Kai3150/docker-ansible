---
- name: Deploy files to remote servers with conditional backup and confirmation
  hosts: all
  become: true
  vars_files:
    - files_to_transfer.yml

  vars:
    backup_dir: "/PF_NAS/UNYO/transfer_backups"

  tasks:
    # loopã§include_tasksã‚’å‘¼ã³å‡ºã™ã“ã¨ã§ã€ãƒ«ãƒ¼ãƒ—å†…ã§blockã‚’ä½¿ã‚ãšã«æ¸ˆã‚€
    # include_tasksã®ä¸­ã§itemã‚’å‚ç…§ã§ãã‚‹ã‚ˆã†ã«loop_controlã§loop_varã‚’æŒ‡å®š

    - name: Initialize new_distribution_items and overwrite_items
      set_fact:
        new_distribution_items: []
        overwrite_items: []
      run_once: true

    - name: Process each file distribution item
      include_tasks: single.yml
      loop: "{{ files_to_transfer }}"
      loop_control:
        loop_var: item


    #############################
    # æ–°è¦é…å¸ƒå‡¦ç†
    #############################
    - name: Confirm new file distribution globally
      pause:
        prompt: "ã€æ–°è¦é…å¸ƒã€‘ãƒ•ã‚¡ã‚¤ãƒ« {{ item.dest }} ã‚’é…å¸ƒã—ã¾ã™ã‹ï¼Ÿ(yes/no)"
      register: new_distribution_confirm_result
      with_items: "{{ new_distribution_items }}"
      loop_control:
        loop_var: item
      when: new_distribution_items|length > 0

    - name: Distribute new files after global confirmation
      copy:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        owner: "{{ item.owner | default('root') }}"
        group: "{{ item.group | default('root') }}"
        mode: "{{ item.mode }}"
      with_items: "{{ new_distribution_items }}"
      loop_control:
        loop_var: item
      when:
        - new_distribution_items|length > 0
        - new_distribution_confirm_result is defined
        - new_distribution_confirm_result.results[ansible_loop.index0].user_input == 'yes'

    #############################
    # ðŸ” ãƒ‡ãƒãƒƒã‚°ã‚³ãƒ¼ãƒ‰
    #############################
    - name: ðŸ”Debug before file deference check
      debug:
        var: item
      # when:
      #   - dest_file_stat.stat.exists == true
      with_items: "{{ overwrite_items }}"
      loop_control:
        loop_var: item


    #############################
    # ä¸Šæ›¸ãå‡¦ç†
    #############################
    - name: Confirm overwriting files globally
      pause:
        prompt: "ã€ä¸Šæ›¸ãé…å¸ƒã€‘ãƒ•ã‚¡ã‚¤ãƒ« {{ item.dest }} ã‚’ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ(yes/no)"
      register: overwrite_confirm_result
      with_items: "{{ overwrite_items }}"
      loop_control:
        loop_var: item
      when: overwrite_items|length > 0

    - name: Overwrite files after global confirmation
      copy:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        owner: "{{ item.owner | default('root') }}"
        group: "{{ item.group | default('root') }}"
        mode: "{{ item.mode }}"
      with_items: "{{ overwrite_items }}"
      loop_control:
        loop_var: item
      when:
        - overwrite_items|length > 0
        - overwrite_confirm_result is defined
        - overwrite_confirm_result.results[ansible_loop.index0].user_input == 'yes'
