# single.yml
# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€å˜ä¸€ã® item ã«å¯¾ã™ã‚‹å‡¦ç†ã‚’å…¨ã¦ã‚¿ã‚¹ã‚¯ã¨ã—ã¦è¨˜è¿°
# inventory_hostnameã¨item.hostã®ä¸€è‡´ãƒã‚§ãƒƒã‚¯ã‚„
# å·®ç•°ãƒã‚§ãƒƒã‚¯å¾Œã®ã‚¿ã‚¹ã‚¯ã‚¹ã‚­ãƒƒãƒ—ãªã©ã¯ã™ã¹ã¦whenã§åˆ¶å¾¡


#############################
# ãƒ›ã‚¹ãƒˆåãŒã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã¨ä¸€è‡´ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
#############################
- name: Check if host does match inventory_hostname
  when: inventory_hostname == item.host
  block:
  #############################
  # é…å¸ƒå…ƒãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±å–å¾—(ãƒ­ãƒ¼ã‚«ãƒ«)
  #############################
  - name: Check if source file exists (on control machine)
    stat:
      path: "{{ item.src }}"
    register: src_file_stat
    delegate_to: localhost

  - name: Fail if source file does not exist
    fail:
      msg: "{{ item.src }} ãŒå­˜åœ¨ã—ã¾ã›ã‚“"
    when: src_file_stat.stat.exists == false

  - name: Success if source file does exist
    when: src_file_stat.stat.exists == true
    block:
    #############################
    # é…å¸ƒå…ˆãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±å–å¾—(ãƒªãƒ¢ãƒ¼ãƒˆ)
    #############################
    - name: Check if destination file exists (on remote host)
      stat:
        path: "{{ item.dest }}"
      register: dest_file_stat


    #############################
    # é…å¸ƒå…ˆãƒ•ã‚¡ã‚¤ãƒ«ãŒç„¡ã„å ´åˆ(æ–°è¦é…å¸ƒ)
    # é…å¸ƒitemã‚’new_distribution_itemsã«è¿½åŠ 
    # copy å‡¦ç†ã¯new_distribution.ymlã§å®Ÿæ–½
    #############################
    - name: Add item to new_distribution_items for new file distribution
      set_fact:
        new_distribution_items: "{{ new_distribution_items + [item] }}"
      when: dest_file_stat.stat.exists == false



    #############################
    # é…å¸ƒå…ˆãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆ(ä¸Šæ›¸ãé…å¸ƒ)
    # copy å‡¦ç†ã¯overwriting.ymlã§å®Ÿæ–½
    #############################
    - name: Task block for overwriting existing file
      when:
        - dest_file_stat.stat.exists == true
        #############################
        # ãƒ•ã‚¡ã‚¤ãƒ«å·®ç•°ãƒã‚§ãƒƒã‚¯
        #############################
        - >
          (item.mode                    != dest_file_stat.stat.mode)      or
          (item.owner | default('root') != dest_file_stat.stat.pw_name)   or
          (item.group | default('root') != dest_file_stat.stat.gr_name)   or
          (src_file_stat.stat.checksum  != dest_file_stat.stat.checksum)

      # ä¸‹è¨˜ã‚¿ã‚¹ã‚¯ã¯å…¨ã¦ãƒ•ã‚¡ã‚¤ãƒ«å·®ç•°ãŒã‚ã‚‹å ´åˆã®ã¿å¿…è¦ã€‚
      # å·®ç•°ãŒãªã‘ã‚Œã°ä½•ã‚‚ã›ãšã“ã®itemå‡¦ç†çµ‚äº†ã€‚

      block:
        #############################
        # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã®è¨­å®š
        #############################
        - name: Set backup file path
          set_fact:
            backup_file_path: "{{ backup_dir }}/{{ inventory_hostname }}_{{ item.dest | basename }}.bak_{{ lookup('pipe', 'date +%Y%m%d%H%M%S') }}"



        #############################
        # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å–å¾— â€»NASä¿å­˜
        #############################
        - name: Ensure backup directory exists on remote NAS
          file:
            path: "{{ backup_dir }}"
            state: directory
            mode: '0755'


        - name: Backup existing remote file to NAS before overwriting
          command: cp "{{ item.dest }}" "{{ backup_file_path }}"

        - name: Verify backup file exists
          stat:
            path: "{{ backup_file_path }}"
          register: backup_file_stat_check


        - name: Fail if backup file not found
          fail:
            msg: "Backup file {{ backup_file_path }} not found after cp command. Overwrite aborted."
          when:
            - backup_file_stat_check.stat.exists == false


        #############################
        # é…å¸ƒitemã‚’overwrite_itemsã«è¿½åŠ 
        # copy å‡¦ç†ã¯overwriting.ymlã§å®Ÿæ–½
        #############################
        - name: Add item to overwrite_items if destination exists and files differ
          set_fact:
            overwrite_items: "{{ overwrite_items + [item] }}"
          when: backup_file_stat_check.stat.exists == true

        # #############################
        # # ğŸ” ãƒ‡ãƒãƒƒã‚°ã‚³ãƒ¼ãƒ‰
        # #############################
        # - name: ğŸ”Debug before file deference check
        #   debug:
        #     var: overwrite_items
        #   # when:
        #   #   - dest_file_stat.stat.exists == true
